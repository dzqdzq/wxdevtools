import{ConsoleModel}from"./ConsoleModel.js";import{isRemoteDebugGame,isRemoteAppserviceMode,getMasterProxyPort}from"../wx_main/util.js";import{NetworkLog}from"./NetworkLog.js";import{each,some,contain,noop,nextTick,map}from"../third_party/licia.js";import{getProxyPort}from"../wx_main/util.js";if(wxMain.isFeatureEnabled("correctRemoteDebugContext")&&"RemoteDebug"===wxMain.type&&!isRemoteDebugGame()&&isRemoteAppserviceMode()){const e=ConsoleModel.prototype.addMessage,t=["WASubContext","WAServiceMainContext"];ConsoleModel.prototype.addMessage=function(s){if(!("error"!==s.type&&t.some(e=>s.url&&s.url.includes(e))||void 0===s.url&&"error"!==s.type&&"console-api"===s.source||"error"===s.type&&s.messageText&&s.messageText.includes("error occurs:ENOENT: no such file or directory, access '/storage/emulated/0/Android/")))return e.apply(this,[s])}}if(wxMain.isFeatureEnabled("hideRequest")){let e=!1;nextTick(()=>{wxMain.on(WxMain.Events.showAllRequests,()=>{e=!0})});const t=wxMain.getFeatureOptions("hideRequest").filter||noop;function filterRequest(s){if(e)return!1;const o=s._url;if(/(\?|&)devtools_ignore=true(&|$)/.test(o))return!0;const r=navigator.userAgent,a=[getProxyPort()];contain(r,"simple")&&a.push(getMasterProxyPort());const i=["https://servicewechat.com/wxa-qbase/qbasecheckresult","https://servicewechat.com/wxa-qbase/container_service","https://servicewechat.com/wxa-qbase/report","https://servicewechat.com/wxa-qbase/keepalive","https://servicewechat.com/ob/wxob"];if(each(a,e=>{i.push(`http://127.0.0.1:${e}/appservice`,`http://127.0.0.1:${e}/__pageframe__/mainframe.html`,`http://127.0.0.1:${e}/__pageframe__/instanceframe.html`,`http://127.0.0.1:${e}/favicon.ico`,`http://127.0.0.1:${e}/apihelper`,`http://127.0.0.1:${e}/jsbridge`,`http://127.0.0.1:${e}/calibration`)}),some(i,e=>contain(o,e)))return!0;if(t(o))return!0;return!!some([/^https:\/\/.+\.cos\.ap-.+\.myqcloud\.com\/wx[^\/]+\/common\/[^\/]+$/,/^https:\/\/.+\.cos\.ap-.+\.myqcloud\.com\/wx[^\/]+\/\d+\/[^\/]+-(appservice|webview)/,/^https:\/\/servicewechat.com\/ob\//],e=>e.test(o))||!(!/^https:\/\/.+\.cos\.ap-.+\.myqcloud\.com\/$/.test(o)||"POST"!==s.requestMethod())}const s=NetworkLog.prototype._addRequest;NetworkLog.prototype._addRequest=function(e){filterRequest(e)||s.call(this,e)};const o=NetworkLog.prototype._onRequestUpdated;NetworkLog.prototype._onRequestUpdated=function(e){filterRequest(e.data)||o.call(this,e)}}if(wxMain.isFeatureEnabled("showEventStream")){wxMain.getMessenger().registerCallback(e=>{const{command:t}=e;if("EMIT_CHUNKED_DATA"===t){const t=NetworkLog.instance()._requests.find(t=>{const s=(t.responseHeaders??[]).find(e=>"for-weapp-devtools"===e.name);if(s){if(JSON.parse(s.value)["appservice-request-id"]===e.data.requestId)return!0}});if(t){const s=(new TextDecoder).decode(new Uint8Array(e.data.data).buffer);let o="",r=0,a="";s.trim().split("\n").forEach(e=>{e.startsWith("event:")&&(o=e.substr(6)),e.startsWith("id:")&&(r=parseInt(e.substr(3))),e.startsWith("data:")&&(a=e.substr(5))}),t.addEventSourceMessage(Date.now()/1e3-t._wallIssueTime+t._issueTime,o,r,a)}}})}if(wxMain.isFeatureEnabled("setMaxRequestLen")){const e=wxMain.getMessenger();let t=999999;e.registerCallback(e=>{"SET_MAX_NETWORK_REQUEST_LENGTH"===e.command&&(t=e.data)}),e.send({command:"GET_MAX_NETWORK_REQUEST_LENGTH"});const s=NetworkLog.prototype._addRequest;NetworkLog.prototype._addRequest=function(e){s.call(this,e);const o=this._requests,r=this._requestsSet,a=this._requests.length;if(a>t){const e=o.slice(0,a-t);this._requests=o.slice(a-t,a),each(e,e=>{if(e.isRedirect()){e.redirectDestination().setRedirectSource(null)}r.delete(e),wxMain.emit(WxMain.Events.requestRemoved,e)}),setTimeout(()=>{wxMain.getMessenger().send({command:"NETWORK_REQUESTS_REMOVED",data:{requestsRemoved:map(e,e=>e.requestId())}})},5e3)}}}