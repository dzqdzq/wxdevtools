import{TimelinePanel}from"./TimelinePanel.js";import{TimelineController}from"./TimelineController.js";import{TimelineFlameChartDataProvider,EntryType}from"./TimelineFlameChartDataProvider.js";import*as TimelineModel from"../timeline_model/timeline_model.js";import*as Common from"../common/common.js";import*as UI from"../ui/ui.js";import*as SDK from"../sdk/sdk.js";import PluginMessenger from"../wx_main/PluginMessenger.js";import{RecordType,TimelineModelImpl}from"../timeline_model/TimelineModel.js";import{TimelineUIUtils,TimelineRecordStyle}from"../timeline/TimelineUIUtils.js";let traceMessenger;function getTraceMessenger(){return traceMessenger||(traceMessenger=new PluginMessenger("PLUGIN_trace_miniprogram"),traceMessenger.send("ON_PANNEL_SHOW")),traceMessenger}if(wxMain.isFeatureEnabled("hackTimeline")){const e=getTraceMessenger(),t=TimelinePanel.instance();TimelinePanel.prototype._selectFileToLoad=function(){e.send("TRACE_CLICK_LOAD")},t._showScreenshotsToolbarCheckbox.setVisible(!1);const n=t._showMemoryToolbarCheckbox.element;n.textElement.textContent=Common.UIString.UIString("Counter"),UI.Tooltip.Tooltip.install(t._showMemoryToolbarCheckbox.inputElement,"Show counters"),UI.Tooltip.Tooltip.install(n.textElement,"Show counters");const i=t._flameChart._countersView,r=i._countersByName,o=i._counterUI;["documents","nodes","jsEventListeners","gpuMemoryUsedKB"].forEach(e=>delete r[e]);for(let e=1,t=o.length;e<t;e++)i._toolbar._contentElement.removeChild(o[e]._filter.element);i._counterUI=o.slice(0,1),i._counters=i._counters.slice(0,1),r.memory=i._createCounter(Common.UIString.UIString("MEMORY"),Common.UIString.UIString("MEMORY [MB]: %s"),"hsl(0, 90%, 43%)"),r.cpu=i._createCounter(Common.UIString.UIString("CPU"),Common.UIString.UIString("CPU [%]: %s"),"hsl(120, 90%, 43%)"),r.fps=i._createCounter(Common.UIString.UIString("FPS"),Common.UIString.UIString("FPS: %s"),"hsl(38, 90%, 43%)"),TimelineController.prototype.startRecording=async function(e,t){function n(e){return"disabled-by-default-"+e}const i=["-*","devtools.timeline",n("devtools.timeline"),"v8.execute"];i.push(TimelineModel.TimelineModel.TimelineModelImpl.Category.LatencyInfo),Root.Runtime.experiments.isEnabled("timelineFlowEvents")&&i.push("devtools.timeline.async"),Root.Runtime.experiments.isEnabled("timelineV8RuntimeCallStats")&&e.enableJSSampling&&i.push(n("v8.runtime_stats_sampling")),!Root.Runtime.queryParam("timelineTracingJSProfileDisabled")&&e.enableJSSampling&&i.push(n("v8.cpu_profiler")),i.push(n("devtools.timeline.stack")),Root.Runtime.experiments.isEnabled("timelineInvalidationTracking")&&i.push(n("devtools.timeline.invalidationTracking")),this._performanceModel.setRecordStartTime(Date.now());const r=await this._startRecordingWithCategories(i.join(","),e.enableJSSampling);return r[ProtocolClient.InspectorBackend.ProtocolError]&&(await this._waitForTracingToStop(!1),await SDK.SDKModel.TargetManager.instance().resumeAllTargets()),r},TimelineFlameChartDataProvider.prototype._processInspectorTrace=function(){this._appendInteractionRecords();const e=EntryType.Event,t=e=>{switch(e.type){case TimelineModel.TimelineModel.TrackType.Timings:return 2;case TimelineModel.TimelineModel.TrackType.Console:return 3;case TimelineModel.TimelineModel.TrackType.Experience:return 4;case TimelineModel.TimelineModel.TrackType.MainThread:return e.forMainFrame?5:6}},n=this._model.tracks().slice();n.sort((e,n)=>t(e)-t(n));for(const t of n)switch(t.type){case TimelineModel.TimelineModel.TrackType.Timings:{const n=t.asyncEvents.length>0?this._collapsibleTimingsHeader:this._timingsHeader;this._appendHeader(ls`Timings`,n,!0)._track=t,this._appendPageMetrics(),this._appendAsyncEventsGroup(t,null,t.asyncEvents,n,e,!0);break}case TimelineModel.TimelineModel.TrackType.Console:this._appendAsyncEventsGroup(t,ls`Console`,t.asyncEvents,this._headerLevel1,e,!0);break;case TimelineModel.TimelineModel.TrackType.MainThread:if(t.forMainFrame){const n=this._appendSyncEvents(t,t.events,t.url?ls`Main \u2014 ${t.url}`:ls`Main`,this._headerLevel1,e,!0);n&&(this._timelineData.selectedGroup=n)}else this._appendSyncEvents(t,t.events,t.url?ls`Frame \u2014 ${t.url}`:ls`Subframe`,this._headerLevel1,e,!0)}this._timelineData.selectedGroup&&(this._timelineData.selectedGroup.expanded=!0);for(let e=0;e<this._extensionInfo.length;e++)this._innerAppendExtensionEvents(e);this._markers.sort((e,t)=>e.startTime()-t.startTime()),this._timelineData.markers=this._markers,this._flowEventIndexById.clear()}}if(wxMain.isFeatureEnabled("hackTimeline")||wxMain.isFeatureEnabled("importTrace")){const e=getTraceMessenger(),t=TimelinePanel.instance();e.on("TRACE_LOAD_FILE",(function({data:e}){e.traceEvents&&(e=e.traceEvents),t.loadFromEvents(e)})),TimelineFlameChartDataProvider.prototype._processGenericTrace=function(){const e=this._buildGroupStyle({shareHeaderLine:!1}),t=this._buildGroupStyle({padding:2,nestingLevel:1,shareHeaderLine:!1}),n=EntryType.Event,i=new Platform.Multimap;for(const e of this._model.tracks())null!==e.thread?i.set(e.thread.process(),e):console.error("Failed to process track");for(const r of i.keysArray()){if(i.size>1){const t=`${r.name()} ${r.id()}`;this._appendHeader(t,e,!1)}for(const e of i.get(r)){this._appendAsyncEventsGroup(e,e.name,e.asyncEvents,this._headerLevel1,n,!0);const i=this._appendSyncEvents(e,e.events,e.name,t,n,!0);this._timelineData.selectedGroup&&e.name!==TimelineModel.TimelineModel.TimelineModelImpl.BrowserMainThreadName||(this._timelineData.selectedGroup=i)}}};const n=TimelineModel.TimelineModel.TimelineModelImpl.prototype._processAsyncEvents;TimelineModel.TimelineModel.TimelineModelImpl.prototype._processAsyncEvents=function(e,t){n.call(this,e,t);const i=e.asyncEvents().filter(e=>e.hasCategory("async"));if(i.length>0){const t=this._ensureNamedTrack("async");t.thread=e,t.asyncEvents=t.asyncEvents=t.asyncEvents.mergeOrdered(i,SDK.TracingModel.Event.compareStartTime)}},SDK.TracingModel.TracingModel.browserMainThread=function(e){const t=e.sortedProcesses();if(!t.length)return null;const n=[],i=[];for(const e of t)e.name().toLowerCase().endsWith("browser")&&n.push(e),i.push(...e.sortedThreads().filter(e=>"CrBrowserMain"===e.name()));if(1===i.length)return i[0];if(1===n.length)return n[0].threadByName("CrBrowserMain");const r=e.devToolsMetadataEvents().filter(e=>"TracingStartedInBrowser"===e.name);return 1===r.length?r[0].thread:null}}if(wxMain.isFeatureEnabled("miniprogramTimeline")){const e=getTraceMessenger(),t=TimelinePanel.prototype._startRecording;TimelinePanel.prototype._startRecording=async function(){if(this._recordingPageReload)try{await new Promise(t=>{const n=()=>{e.off("RELAUNCHED",n),t()};e.on("RELAUNCHED",n),e.send("RELAUNCH_FOR_PROFILE")}),await new Promise(e=>setTimeout(e,1e3)),this._recordingPageReload=!1}catch(e){console.error(e)}t.call(this)};const n=TimelinePanel.prototype._recordingStarted;TimelinePanel.prototype._recordingStarted=async function(){this._recordingPageReload&&(this._recordingPageReload=!1),n.call(this)},TimelineController.prototype.startRecording=async function(e,t){function n(e){return"disabled-by-default-"+e}const i=["miniprogram.client","miniprogram.webview","miniprogram.trace.LifeCycle","miniprogram.trace.API","miniprogram.timeline",n("v8.cpu_profiler")];e.captureFilmStrip&&i.push(n("miniprogram.screenshot")),this._performanceModel.setRecordStartTime(Date.now());const r=await this._startRecordingWithCategories(i.join(","),e.enableJSSampling);return r[ProtocolClient.InspectorBackend.ProtocolError]&&(await this._waitForTracingToStop(!1),await SDK.SDKModel.TargetManager.instance().resumeAllTargets()),r},RecordType.MiniProgram="MiniProgram",RecordType.MarkMiniProgram="MarkMiniProgram",RecordType.ClientTask="ClientTask",RecordType.APITask="APITask",RecordType.FrameworkTask="FrameworkTask",TimelineModelImpl.Category.MiniProgram="miniprogram.timeline";const i=TimelineModelImpl.prototype.setEvents;TimelineModelImpl.prototype.setEvents=function(e){i.call(this,e),this._buildMiniProgramTrack(e)},TimelineModelImpl.prototype._buildMiniProgramTrack=function(e){[e.processByName("MiniProgramAppService"),e.processByName("MiniProgramComponentFramework"),e.processByName("MiniProgramWebview"),e.processByName("MiniProgramClient")].forEach(t=>{t&&t.sortedThreads().forEach(t=>{const n=this._tracks.length;this._processThreadEvents(e,[{from:0,to:1/0}],t,!1,!0,!0,null);this._tracks[n].name=t.name()})})};const r=TimelineModelImpl.prototype.isMarkerEvent;TimelineModelImpl.prototype.isMarkerEvent=function(e){return e.name===RecordType.MarkMiniProgram||r.call(this,e)};let o=!1;const a=TimelineUIUtils._initEventStyles;TimelineUIUtils._initEventStyles=function(){try{const e=a.call(this);if(!o){o=!0;const t=TimelineUIUtils.categories();e[RecordType.ClientTask]=new TimelineRecordStyle(RecordType.ClientTask,t.loading),e[RecordType.APITask]=new TimelineRecordStyle(RecordType.APITask,t.rendering),e[RecordType.FrameworkTask]=new TimelineRecordStyle(RecordType.FrameworkTask,t.painting)}return e}catch(e){return console.error(e),a.call(this)}};const s=TimelineUIUtils.eventTitle;TimelineUIUtils.eventTitle=function(e){switch(e.name){case RecordType.ClientTask:case RecordType.APITask:case RecordType.FrameworkTask:return(e.args.data||{}).name;default:return s.call(this,e)}};const l=TimelineUIUtils.buildDetailsNodeForTraceEvent;TimelineUIUtils.buildDetailsNodeForTraceEvent=async function(e,t,n){switch(e.name){case RecordType.ClientTask:case RecordType.APITask:case RecordType.FrameworkTask:const i=await TimelineUIUtils.buildDetailsTextForTraceEvent(e,t);return i?createTextNode(i):null;default:return l.call(this,e,t,n)}};const c=TimelineUIUtils.buildDetailsTextForTraceEvent;TimelineUIUtils.buildDetailsTextForTraceEvent=async function(e,t){switch(e.name){case RecordType.ClientTask:case RecordType.APITask:case RecordType.FrameworkTask:const n=(e.args.data||{}).args;return n?"string"==typeof n?n:JSON.stringify(n):void 0;default:return c.call(this,e,t)}};const m=TimelineUIUtils.markerShortTitle;TimelineUIUtils.markerShortTitle=function(e){switch(e.name){case RecordType.MarkMiniProgram:const t=e.args.data;switch(t.name){case"first-paint":return"FP";case"first-contentful-paint":return"FCP";case"largest-contentful-paint":return"LCP";default:return t.name}default:return m.call(this,e)}};const d=TimelineUIUtils.markerStyleForEvent;TimelineUIUtils.markerStyleForEvent=function(e){switch(e.name){case RecordType.MarkMiniProgram:{const t=[6,4],n=TimelineUIUtils.eventTitle(e);let i=!1,r="grey";switch(e.args.data.name){case"first-paint":r="#228847",i=!0;break;case"first-contentful-paint":r="#1A6937",i=!0;break;case"largest-contentful-paint":r="#1A3422",i=!0}return{title:n,dashStyle:t,lineWidth:.5,color:r,tall:i,lowPriority:!1}}default:return d.call(this,e)}}}TimelineModel.TimelineModel.TimelineModelImpl.prototype._buildLoadingEvents=function(e,t){const n=e.threadByName("Renderer","CrRendererMain");if(!n)return;const i=this._ensureNamedTrack(TimelineModel.TimelineModel.TrackType.Experience);i.thread=n,i.events=t;for(const e of i.events)if(e.categoriesString="experience",e.name===TimelineModel.TimelineModel.RecordType.LayoutShift){const t=e.args.data||e.args.beginData||{},n=TimelineModel.TimelineModel.TimelineData.forEvent(e);t.impacted_nodes&&(n.backendNodeId=t.impacted_nodes[0].node_id)}};