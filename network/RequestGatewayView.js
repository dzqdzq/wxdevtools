import*as Common from"../common/common.js";import*as UI from"../ui/ui.js";import{Category}from"./RequestHeadersView.js";import{safeGet}from"../third_party/licia.js";export class RequestGatewayView extends UI.Widget.VBox{constructor(e){super(),this.registerRequiredCSS("network/requestHeadersView.css"),this.element.classList.add("request-headers-view"),this._request=e;const t=new UI.TreeOutline.TreeOutlineInShadow;t.registerRequiredCSS("object_ui/objectValue.css"),t.registerRequiredCSS("object_ui/objectPropertiesSection.css"),t.registerRequiredCSS("network/requestHeadersTree.css"),t.element.classList.add("request-headers-tree"),t.makeDense(),this.element.appendChild(t.element),this._generalCategory=new Category(t,"general",Common.UIString.UIString("General")),this._generalCategory.hidden=!1,this._securityCategory=new Category(t,"security",Common.UIString.UIString("Security")),this._securityCategory.hidden=!1,this._timingAndStatisticsCategory=new Category(t,"timingAndStatistics",Common.UIString.UIString("Timing and Statistics")),this._timingAndStatisticsCategory.hidden=!1}wasShown(){this._clearHighlight(),this._refreshGeneral(),this._refreshSecurity(),this._refreshTimingAndStatistics(),this._generalCategory.select(!0,!1)}_formatHeader(e,t){const s=createDocumentFragment();return s.createChild("div","header-name").textContent=e+": ",s.createChild("span","header-separator"),s.createChild("div","header-value source-code").textContent=t,s}async _refreshGeneral(){const e=this._generalCategory;e.removeChildren();const t=await this._getRequestContent(),s=(t,s)=>{e.appendChild(new UI.TreeOutline.TreeElement(this._formatHeader(t,s)))};s("CallID",t.callID),s("Protocol",safeGet(t,"stats.protocol")||"Private Protocol"),s("Gateway domain",safeGet(t,"stats.domain")||"Weixin Tunnel")}async _refreshSecurity(){const e=this._securityCategory;e.removeChildren();const t=await this._getRequestContent(),s=(t,s)=>{e.appendChild(new UI.TreeOutline.TreeElement(this._formatHeader(t,s)))};s("Cipher",t.stats?"AES-128-CBC":"MMTLS"),s("Backend","wasm"===safeGet(t,"stats.backend")?"WebAssembly":"Other"),s("Key Exchange",t.stats?"Dynamic":"MMTLS"),t.stats&&s("Compression","snappy")}async _refreshTimingAndStatistics(){const e=this._timingAndStatisticsCategory;e.removeChildren();const t=await this._getRequestContent(),s=(t,s)=>{e.appendChild(new UI.TreeOutline.TreeElement(this._formatHeader(t,s)))},{stats:i}=t;i?(s("Encryption Cost",i.encrypt+"ms"),s("Decryption Cost",i.decrypt+"ms"),s("Request Cost",i.httpRequest+"ms"),s("Upstream Cost",i.upstreamCost+"ms"),s("Request Body Bytes",i.requestBodyBytes),s("Response Body Bytes",i.responseBodyBytes)):e.appendChild(new UI.TreeOutline.TreeElement("Timing details is not available for MMTLS."))}_clearHighlight(){this._highlightedElement&&this._highlightedElement.listItemElement.classList.remove("header-highlight"),this._highlightedElement=null}async _getRequestContent(){const{content:e}=await this._request.requestContent();return e?JSON.parse(e):{}}}export class RequestGatewayPromoView extends UI.Widget.VBox{constructor(){super(),this.registerRequiredCSS("network/requestGatewayView.css"),this.element.classList.add("request-gateway-promo-view");const e=document.createElement("div");e.classList.add("request-gateway-promo-content"),e.innerHTML='\n      <h2>微信安全网关</h2>\n      <p>\n        微信安全网关是微信小程序团队推出的面向小程序网络安全与性能的解决方案，可有效提升网络请求成功率，解决业务性能及各种网络疑难问题，提高用户体验。\n        <a target="_blank" href="https://dev.weixin.qq.com/products/gateway?utm_source=ide_toolconsole_2">免费试用</a>\n      </p>\n      <h2>产品优势</h2>\n      <ul>\n        <li>守护数据安全，100%数据加密，高效预防数据泄露</li>\n        <li>拦截恶意流量，可抵御99%以上异常流量</li>\n        <li>网络性能优化，网络请求成功率可提升至99.9%以上</li>\n        <li>弱网加速，弱网环境下最高可提升300%访问速度</li>\n      </ul>',this.element.appendChild(e)}wasShown(){super.wasShown(),wxMain.getMessenger().send({command:"REPORT_ACTION",data:{Action:1100,Data:"2"}})}}